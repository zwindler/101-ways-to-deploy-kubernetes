---
// FilterBar.astro - Interactive filter bar for Kubernetes deployment solutions

interface Props {
  categories: string[];
  cloudProviders: string[];
  tags: string[];
}

const { categories, cloudProviders, tags } = Astro.props;

// Utility function to format category names with spaces between words
function formatCategoryName(category: string): string {
  // Insert space before uppercase letters (except at the start)
  return category.replace(/([a-z])([A-Z])/g, '$1 $2');
}
---

<div
  id="filter-bar"
  class="filter-bar sticky top-0 z-10 bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm mb-6"
>
  <!-- Mobile filter toggle button (visible only on mobile) -->
  <button
    id="mobile-filter-toggle"
    class="md:hidden w-full flex items-center justify-between px-4 py-3 bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 font-medium hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors mb-3"
  >
    <span class="flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
      </svg>
      <span>Filters</span>
      <span id="filter-count-badge" class="hidden px-2 py-0.5 bg-blue-600 text-white text-xs rounded-full">0</span>
    </span>
    <svg id="mobile-filter-chevron" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>

  <!-- Filter content (collapsible on mobile) -->
  <div id="filter-content" class="hidden md:block">
    <!-- Category filters row (with Tags dropdown right-aligned) -->
    <div class="flex flex-wrap items-center gap-2 mb-3">
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-1">Categories:</span>
      <button class="filter-pill active" data-category="all">All</button>
      {
        categories.map((cat) => (
          <button class="filter-pill" data-category={cat}>
            {formatCategoryName(cat)}
          </button>
        ))
      }

      <!-- Tags dropdown (right-aligned in the categories row) -->
      <div class="relative ml-auto">
        <button
          id="tags-dropdown-button"
          type="button"
          class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors flex items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-600"
        >
          <span id="tags-dropdown-label">Tags</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div
          id="tags-dropdown-menu"
          class="hidden absolute top-full right-0 mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-20 max-h-64 overflow-hidden min-w-[200px]"
        >
          <!-- Search input -->
          <div class="p-2 border-b border-gray-300 dark:border-gray-600">
            <input
              type="text"
              id="tags-search-input"
              placeholder="Search tags..."
              class="w-full px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <!-- Tags list -->
          <div id="tags-list" class="p-2 space-y-1 max-h-48 overflow-y-auto">
            {
              tags.map((tag) => (
                <label class="tag-option flex items-center gap-2 px-2 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-600 rounded cursor-pointer text-sm" data-tag-label={tag.toLowerCase()}>
                  <input
                    type="checkbox"
                    data-tag={tag}
                    class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
                  />
                  <span class="text-gray-700 dark:text-gray-300">{tag}</span>
                </label>
              ))
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Secondary filters row -->
    <div class="flex flex-wrap items-center gap-4">
    <!-- Cloud provider dropdown -->
    <div id="cloud-provider-container" class="hidden">
      <select
        id="cloud-provider-filter"
        class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
      >
        <option value="">All providers</option>
        {
          cloudProviders.map((provider) => (
            <option value={provider}>{provider.toUpperCase()}</option>
          ))
        }
      </select>
    </div>

    <!-- Detailed view toggle -->
    <label class="flex items-center gap-2 cursor-pointer text-sm text-gray-700 dark:text-gray-300">
      <input
        type="checkbox"
        id="detailed-view-filter"
        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
      />
      <span>Detailed view</span>
    </label>

    <!-- Production ready toggle -->
    <label class="flex items-center gap-2 cursor-pointer text-sm text-gray-700 dark:text-gray-300">
      <input
        type="checkbox"
        id="production-ready-filter"
        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
      />
      <span>Production Ready only</span>
    </label>

    <!-- Status checkboxes -->
    <div class="flex items-center gap-3">
      <span class="text-sm text-gray-500 dark:text-gray-400">Status:</span>
      <label class="flex items-center gap-1 cursor-pointer text-sm text-gray-700 dark:text-gray-300">
        <input
          type="checkbox"
          checked
          data-status="active"
          class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
        />
        <span>Active</span>
      </label>
      <label class="flex items-center gap-1 cursor-pointer text-sm text-gray-700 dark:text-gray-300">
        <input
          type="checkbox"
          data-status="abandoned"
          class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
        />
        <span>Abandoned</span>
      </label>
    </div>

    <!-- Open source toggle (placed at the end so stars filter appears without shifting elements) -->
    <label class="flex items-center gap-2 cursor-pointer text-sm text-gray-700 dark:text-gray-300">
      <input
        type="checkbox"
        id="oss-filter"
        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
      />
      <span>Open Source only</span>
    </label>

    <!-- Stars count filter (visible only when Open Source only is checked) -->
    <div id="stars-filter-container" class="hidden">
      <select
        id="stars-filter"
        class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
      >
        <option value="">‚≠ê Any stars</option>
        <option value="100">&gt; 100 stars</option>
        <option value="1000">&gt; 1k stars</option>
        <option value="10000">&gt; 10k stars</option>
      </select>
    </div>

      <!-- Clear button -->
      <button
        id="clear-filters"
        class="text-sm text-blue-600 dark:text-blue-400 hover:underline hidden ml-auto"
      >
        Clear all
      </button>
    </div>
  </div>
</div>

<script>
  // Client-side JavaScript for filtering logic
  
  interface FilterState {
    category: string;
    cloudProvider: string;
    openSourceOnly: boolean;
    productionReadyOnly: boolean;
    statuses: string[];
    tags: string[];
    minStars: number;
  }

  // Get filter state
  function getFilterState(): FilterState {
    const activeCategoryBtn = document.querySelector('.filter-pill.active');
    const category = activeCategoryBtn?.getAttribute('data-category') || 'all';
    
    const cloudProviderSelect = document.getElementById('cloud-provider-filter') as HTMLSelectElement | null;
    const cloudProvider = cloudProviderSelect?.value || '';
    
    const ossCheckbox = document.getElementById('oss-filter') as HTMLInputElement | null;
    const openSourceOnly = ossCheckbox?.checked || false;
    
    const productionReadyCheckbox = document.getElementById('production-ready-filter') as HTMLInputElement | null;
    const productionReadyOnly = productionReadyCheckbox?.checked || false;
    
    const statusCheckboxes = document.querySelectorAll('[data-status]:checked');
    const statuses = Array.from(statusCheckboxes).map(
      (cb) => (cb as HTMLElement).getAttribute('data-status') || ''
    ).filter(Boolean);
    
    const tagCheckboxes = document.querySelectorAll('input[data-tag]:checked');
    const tags = Array.from(tagCheckboxes).map(
      (cb) => (cb as HTMLElement).getAttribute('data-tag') || ''
    ).filter(Boolean);
    
    const starsSelect = document.getElementById('stars-filter') as HTMLSelectElement | null;
    const minStars = starsSelect?.value ? parseInt(starsSelect.value, 10) : 0;
    
    return { category, cloudProvider, openSourceOnly, productionReadyOnly, statuses, tags, minStars };
  }

  // Emit filter change event
  function emitFilterChange() {
    const filterState = getFilterState();
    const event = new CustomEvent('filter-change', {
      detail: filterState,
      bubbles: true,
    });
    document.dispatchEvent(event);
    updateClearButtonVisibility();
    updateCloudProviderVisibility();
    updateStarsFilterVisibility();
    updateTagsDropdownLabel();
  }

  // Update clear button visibility
  function updateClearButtonVisibility() {
    const clearBtn = document.getElementById('clear-filters');
    if (!clearBtn) return;
    
    const filterState = getFilterState();
    const hasDefaultStatus = filterState.statuses.length === 1 && filterState.statuses[0] === 'active';
    
    let filterCount = 0;
    if (filterState.category !== 'all') filterCount++;
    if (filterState.cloudProvider !== '') filterCount++;
    if (filterState.openSourceOnly) filterCount++;
    if (filterState.productionReadyOnly) filterCount++;
    if (!hasDefaultStatus) filterCount++;
    if (filterState.tags.length > 0) filterCount++;
    if (filterState.minStars > 0) filterCount++;
    
    const hasActiveFilters = filterCount > 0;
    clearBtn.classList.toggle('hidden', !hasActiveFilters);
    updateMobileFilterBadge(filterCount);
  }

  // Update mobile filter badge count
  function updateMobileFilterBadge(filterCount: number) {
    const badge = document.getElementById('filter-count-badge');
    if (!badge) return;
    
    if (filterCount > 0) {
      badge.textContent = filterCount.toString();
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }

  // Toggle mobile filter visibility
  function toggleMobileFilters() {
    const content = document.getElementById('filter-content');
    const chevron = document.getElementById('mobile-filter-chevron');
    
    if (!content || !chevron) return;
    
    const isHidden = content.classList.contains('hidden');
    
    if (isHidden) {
      content.classList.remove('hidden');
      chevron.classList.add('rotate-180');
    } else {
      content.classList.add('hidden');
      chevron.classList.remove('rotate-180');
    }
  }

  // Update cloud provider dropdown visibility
  function updateCloudProviderVisibility() {
    const filterState = getFilterState();
    const container = document.getElementById('cloud-provider-container');
    if (!container) return;
    
    const showCloudProvider = filterState.category === 'Managed' || filterState.category === 'InfraAsCode';
    container.classList.toggle('hidden', !showCloudProvider);
  }

  // Update stars filter visibility (only shown when open source is checked)
  function updateStarsFilterVisibility() {
    const filterState = getFilterState();
    const container = document.getElementById('stars-filter-container');
    if (!container) return;
    
    container.classList.toggle('hidden', !filterState.openSourceOnly);
    
    // Reset stars filter when OSS filter is unchecked
    if (!filterState.openSourceOnly) {
      const starsSelect = document.getElementById('stars-filter') as HTMLSelectElement | null;
      if (starsSelect) starsSelect.value = '';
    }
  }

  // Toggle tags dropdown visibility
  function toggleTagsDropdown() {
    const menu = document.getElementById('tags-dropdown-menu');
    if (!menu) return;
    
    const isHidden = menu.classList.contains('hidden');
    menu.classList.toggle('hidden');
    
    // Focus the search input when opening the dropdown
    if (isHidden) {
      const searchInput = document.getElementById('tags-search-input') as HTMLInputElement | null;
      if (searchInput) {
        // Small delay to ensure DOM updates complete before focusing
        setTimeout(() => searchInput.focus(), 100);
      }
    }
  }

  // Filter tags based on search input
  function filterTags() {
    const searchInput = document.getElementById('tags-search-input') as HTMLInputElement | null;
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const tagOptions = document.querySelectorAll('.tag-option');
    
    tagOptions.forEach((option) => {
      const tagLabel = (option as HTMLElement).getAttribute('data-tag-label') || '';
      const matches = tagLabel.includes(searchTerm);
      (option as HTMLElement).style.display = matches ? '' : 'none';
    });
  }

  // Update tags dropdown label
  function updateTagsDropdownLabel() {
    const label = document.getElementById('tags-dropdown-label');
    if (!label) return;
    
    const selectedTags = getFilterState().tags;
    if (selectedTags.length === 0) {
      label.textContent = 'Tags';
    } else {
      label.textContent = `Tags (${selectedTags.length})`;
    }
  }

  // Clear all filters
  function clearAllFilters() {
    // Reset category to "all"
    document.querySelectorAll('.filter-pill').forEach((btn) => {
      btn.classList.remove('active');
      if (btn.getAttribute('data-category') === 'all') {
        btn.classList.add('active');
      }
    });
    
    // Reset cloud provider
    const cloudProviderSelect = document.getElementById('cloud-provider-filter') as HTMLSelectElement | null;
    if (cloudProviderSelect) cloudProviderSelect.value = '';
    
    // Reset open source checkbox
    const ossCheckbox = document.getElementById('oss-filter') as HTMLInputElement | null;
    if (ossCheckbox) ossCheckbox.checked = false;
    
    // Reset production ready checkbox
    const productionReadyCheckbox = document.getElementById('production-ready-filter') as HTMLInputElement | null;
    if (productionReadyCheckbox) productionReadyCheckbox.checked = false;
    
    // Reset status checkboxes - only active checked
    document.querySelectorAll('[data-status]').forEach((cb) => {
      const checkbox = cb as HTMLInputElement;
      const status = cb.getAttribute('data-status');
      checkbox.checked = status === 'active';
    });
    
    // Reset tag checkboxes
    document.querySelectorAll('input[data-tag]').forEach((cb) => {
      const checkbox = cb as HTMLInputElement;
      checkbox.checked = false;
    });
    
    // Reset stars filter
    const starsSelect = document.getElementById('stars-filter') as HTMLSelectElement | null;
    if (starsSelect) starsSelect.value = '';
    
    updateTagsDropdownLabel();
    emitFilterChange();
  }

  // Initialize event listeners
  function initFilterBar() {
    // Mobile filter toggle
    const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
    mobileFilterToggle?.addEventListener('click', toggleMobileFilters);
    
    // Category pills
    document.querySelectorAll('.filter-pill').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        
        // Toggle active state
        document.querySelectorAll('.filter-pill').forEach((b) => {
          b.classList.remove('active');
        });
        target.classList.add('active');
        
        emitFilterChange();
      });
    });
    
    // Cloud provider dropdown
    const cloudProviderSelect = document.getElementById('cloud-provider-filter');
    cloudProviderSelect?.addEventListener('change', emitFilterChange);
    
    // Open source checkbox
    const ossCheckbox = document.getElementById('oss-filter');
    ossCheckbox?.addEventListener('change', emitFilterChange);
    
    // Production ready checkbox
    const productionReadyCheckbox = document.getElementById('production-ready-filter');
    productionReadyCheckbox?.addEventListener('change', emitFilterChange);
    
    // Detailed view checkbox
    const detailedViewCheckbox = document.getElementById('detailed-view-filter');
    detailedViewCheckbox?.addEventListener('change', () => {
      const isDetailed = (detailedViewCheckbox as HTMLInputElement).checked;
      const event = new CustomEvent('detailed-view-change', {
        detail: { isDetailed },
        bubbles: true,
      });
      document.dispatchEvent(event);
    });
    
    // Status checkboxes
    document.querySelectorAll('[data-status]').forEach((cb) => {
      cb.addEventListener('change', emitFilterChange);
    });
    
    // Tags dropdown button
    const tagsDropdownButton = document.getElementById('tags-dropdown-button');
    tagsDropdownButton?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleTagsDropdown();
    });
    
    // Tags search input
    const tagsSearchInput = document.getElementById('tags-search-input');
    tagsSearchInput?.addEventListener('input', filterTags);
    
    // Prevent dropdown from closing when clicking inside
    const tagsDropdownMenu = document.getElementById('tags-dropdown-menu');
    tagsDropdownMenu?.addEventListener('click', (e) => {
      e.stopPropagation();
    });
    
    // Tags checkboxes
    document.querySelectorAll('input[data-tag]').forEach((cb) => {
      cb.addEventListener('change', () => {
        updateTagsDropdownLabel();
        emitFilterChange();
      });
    });
    
    // Stars filter dropdown
    const starsSelect = document.getElementById('stars-filter');
    starsSelect?.addEventListener('change', emitFilterChange);
    
    // Close tags dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('tags-dropdown-menu');
      const button = document.getElementById('tags-dropdown-button');
      if (menu && button && !menu.classList.contains('hidden')) {
        const target = e.target as HTMLElement;
        if (!menu.contains(target) && !button.contains(target)) {
          menu.classList.add('hidden');
          // Clear search input when closing
          const searchInput = document.getElementById('tags-search-input') as HTMLInputElement | null;
          if (searchInput) {
            searchInput.value = '';
            filterTags();
          }
        }
      }
    });
    
    // Clear button
    const clearBtn = document.getElementById('clear-filters');
    clearBtn?.addEventListener('click', clearAllFilters);
    
    // Initial state
    updateClearButtonVisibility();
    updateCloudProviderVisibility();
    updateStarsFilterVisibility();
    updateTagsDropdownLabel();
  }

  // Listen for filters-reset event from outside (e.g., reset button in page)
  window.addEventListener('filters-reset', () => {
    clearAllFilters();
  });

  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFilterBar);
  } else {
    initFilterBar();
  }
</script>

<style>
  .filter-pill {
    @apply px-3 py-1.5 rounded-full text-sm font-medium;
    @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
    @apply dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600;
  }
  .filter-pill.active {
    @apply bg-blue-600 text-white hover:bg-blue-700;
  }
</style>
