---
import Layout from '../layouts/Layout.astro';
import SearchBar from '../components/SearchBar.astro';
import FilterBar from '../components/FilterBar.astro';
import SolutionCard from '../components/SolutionCard.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import yaml from 'js-yaml';
import fs from 'fs';
import path from 'path';

// Load solutions data
const solutionsFile = fs.readFileSync(path.join(process.cwd(), 'data/solutions.yaml'), 'utf8');
const data = yaml.load(solutionsFile) as { solutions: any[] };
const solutions = data.solutions;

// Extract unique categories, cloud providers, and tags for filters
const categories = [...new Set(solutions.map(s => s.category))].sort();
const cloudProviders = [...new Set(solutions.flatMap(s => s.cloud_providers || []))].sort();
const tags = [...new Set(solutions.flatMap(s => s.tags || []))].sort();
---

<Layout title="101 Ways to Deploy Kubernetes">
  <main class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Hero Section -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-16 px-4 relative">
      <div class="max-w-6xl mx-auto text-center">
        <div class="flex justify-between items-start mb-4">
          <div class="flex-1"></div>
          <h1 class="flex-1 text-4xl md:text-5xl font-bold leading-tight">
            <span class="text-gray-400">(more than)</span> <span class="whitespace-nowrap">101 Ways to Deploy</span><br />Kubernetes
          </h1>
          <div class="flex-1 flex justify-end">
            <ThemeToggle />
          </div>
        </div>
        <p class="text-xl text-blue-100 mb-8">
          A comprehensive list of {solutions.length} ways to deploy Kubernetes!
        </p>
        
        <!-- Search Bar -->
        <SearchBar />
      </div>
    </header>
    
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- Filter Bar -->
      <FilterBar categories={categories} cloudProviders={cloudProviders} tags={tags} />
      
      <!-- Results count -->
      <div class="mb-6 text-gray-600 dark:text-gray-400">
        <span id="results-count">{solutions.length}</span> solutions
      </div>
      
      <!-- Solutions Grid -->
      <div id="solutions-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {solutions.map((solution) => (
          <div class="solution-item" 
               data-category={solution.category}
               data-name={solution.name.toLowerCase()}
               data-publisher={solution.publisher?.toLowerCase() || ''}
               data-description={solution.description?.toLowerCase() || ''}
               data-tags={solution.tags?.join(' ').toLowerCase() || ''}
               data-based-on={solution.based_on?.join(' ').toLowerCase() || ''}
               data-cloud-providers={solution.cloud_providers?.join(' ').toLowerCase() || ''}
               data-open-source={solution.open_source ? 'true' : 'false'}
               data-abandoned={solution.abandoned ? 'true' : 'false'}>
            <SolutionCard solution={solution} />
          </div>
        ))}
      </div>
      
      <!-- No results message -->
      <div id="no-results" class="hidden text-center py-12">
        <p class="text-gray-500 dark:text-gray-400 text-lg">
          No solutions match your search criteria.
        </p>
        <button id="reset-filters" class="mt-4 text-blue-600 hover:underline">
          Clear all filters
        </button>
      </div>
    </div>
    
    <!-- Footer -->
    <footer class="bg-gray-100 dark:bg-gray-800 py-8 mt-12">
      <div class="max-w-6xl mx-auto px-4 text-center text-gray-600 dark:text-gray-400">
        <p>
          Created by <a href="https://github.com/zwindler" class="text-blue-600 hover:underline">@zwindler</a>
        </p>
        <p class="mt-2 text-sm">
          Licensed under CC BY-SA 4.0 â€¢ 
          <a href="https://github.com/zwindler/101-ways-to-deploy-kubernetes" class="hover:underline">Contribute on GitHub</a>
        </p>
      </div>
    </footer>
  </main>
</Layout>

<script>
  let currentSearch = '';
  let currentFilters = {
    category: 'all',
    cloudProvider: '',
    openSourceOnly: false,
    statuses: ['active'],
    tags: [] as string[]
  };

  function filterSolutions() {
    const items = document.querySelectorAll('.solution-item');
    let visibleCount = 0;

    items.forEach((item) => {
      const el = item as HTMLElement;
      let visible = true;

      // Search filter
      if (currentSearch) {
        const searchableText = [
          el.dataset.name,
          el.dataset.publisher,
          el.dataset.description,
          el.dataset.tags,
          el.dataset.basedOn,
        ].join(' ');
        visible = searchableText.includes(currentSearch);
      }

      // Category filter
      if (visible && currentFilters.category !== 'all') {
        visible = el.dataset.category === currentFilters.category;
      }

      // Cloud provider filter
      if (visible && currentFilters.cloudProvider) {
        visible = el.dataset.cloudProviders?.includes(currentFilters.cloudProvider) || false;
      }

      // Open source filter
      if (visible && currentFilters.openSourceOnly) {
        visible = el.dataset.openSource === 'true';
      }

      // Status filter
      if (visible && currentFilters.statuses.length > 0) {
        const isAbandoned = el.dataset.abandoned === 'true';
        const itemStatus = isAbandoned ? 'abandoned' : 'active';
        visible = currentFilters.statuses.includes(itemStatus);
      }

      // Tags filter
      if (visible && currentFilters.tags.length > 0) {
        const itemTags = el.dataset.tags?.split(' ') || [];
        const normalizedFilterTags = currentFilters.tags.map(tag => tag.toLowerCase());
        visible = normalizedFilterTags.some(tag => itemTags.includes(tag));
      }

      el.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    // Update count
    const countEl = document.getElementById('results-count');
    if (countEl) countEl.textContent = visibleCount.toString();

    // Show/hide no results message
    const noResults = document.getElementById('no-results');
    const grid = document.getElementById('solutions-grid');
    if (noResults && grid) {
      noResults.classList.toggle('hidden', visibleCount > 0);
      grid.classList.toggle('hidden', visibleCount === 0);
    }

    // Dispatch count update for SearchBar
    window.dispatchEvent(new CustomEvent('solutions-count-update', {
      detail: { count: visibleCount }
    }));
  }

  // Listen for search changes
  window.addEventListener('search-change', ((e: CustomEvent) => {
    currentSearch = e.detail.query;
    filterSolutions();
  }) as EventListener);

  // Listen for filter changes
  window.addEventListener('filter-change', ((e: CustomEvent) => {
    currentFilters = { ...currentFilters, ...e.detail };
    filterSolutions();
  }) as EventListener);

  // Reset filters button
  document.getElementById('reset-filters')?.addEventListener('click', () => {
    currentSearch = '';
    currentFilters = {
      category: 'all',
      cloudProvider: '',
      openSourceOnly: false,
      statuses: ['active'],
      tags: []
    };
    // Dispatch reset events
    window.dispatchEvent(new CustomEvent('filters-reset'));
    filterSolutions();
  });
</script>

<script>
  // Staggered fade-in animation for solution cards on page load
  document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.solution-item');
    cards.forEach((card, index) => {
      const el = card as HTMLElement;
      // Only animate first 15 cards for better performance with large lists
      if (index < 15) {
        el.style.opacity = '0';
        el.style.animation = `fadeInUp 0.5s ease-out ${index * 50}ms forwards`;
      }
    });
  });
</script>
